# redis 布隆过滤器与位图



由于业务需求，需要判断某个用户在某年月是否有登录。如果登录，则去数据库查询相关信息。为了尽可能的减少数据库查询，需要使用其他方案来优化。

假设每月有100000不重复用户登录

| 方案 | key | offset | value | 占用内存 |
| :--- | :--- | :--- | :--- | :--- |
| set | uid-y-m |  | 1 | 142.92M |
| set | uid-y |  | value = 0; value \|=   \(1 &lt;&lt; m\) | 12.21M |
| setbit | uid | m - 起始年份 \(可由二分算的，或提前算好\) | 1 | 11.21M |
| setbit | y-m | uid hash函数计算，得出8个bit下标 | 1 | 3.82M |

**set**

* 第二种方案是在第一种的基础上优化，将一年12个月的登录状态压缩为1个整数，内存占用为1/12 
* redis int 是8个字节的长整型 ，可以存储64位 。可以在优化为，将多年的登录状态压缩为1个整数 
* redis 会共享小范围的整数对象.范围在\[0-9999\] 这也是一个考虑点 。（默认一个对象可共享10000次）
* 9999 &gt;8191 =  \(1 &lt;&lt; 13\) -1 

**位图**

* setbit   思路与第二种方案相似，只是redis支持setbit。少了一些额外的计算工作
* key = uid    offset = m - 起始年份 \(可由二分算的，或提前算好\)
* 每个用户uid作为key,每个月占1位。如果出现某个用户好几月未登录，那么就浪费了几位
* 如果以y-m做Key,那么占用的位与uid长度相关 

#### 布隆过滤

* 布隆过滤概念在网上很多，搜索下都可以查到 贴上我参考的文章，主要看其中概率计算的方法。 [http://imhuchao.com/1271.html](http://imhuchao.com/1271.html) k=8, m = n \* 10 误判率在: 0.00846
* 目前有100000用户，那么需要100000 \* 10 位。
* key 一年只有12个 
* hash 比较耗时

**总结**

布隆过滤还有其他合适的场景，例如Url唯一，用户昵称唯一判断等。 如何使用，还是得结合场景来综合考虑 redis 内存占用，除了与value相关，key也是重要因素。因为redis内部是通过一个大的字典来存储全部的key。

